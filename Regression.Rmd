---
title: "L_Regression_9.3"
author: "Adriana RM"
date: "9/3/2020"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
library(dplyr)
knitr::opts_chunk$set(echo = TRUE)

```

## Setting Reference Levels 
```{r}

# Change reference level for RACEi to Non-Hispanc White
dft1 = dft1 %>% mutate(RACEgroup = relevel(RACEgroup,"NHWhite"))

```

## Logistic Regression Ungrouped RACEi

```{r}
## Group RACEi according to:
# For categorizations, we combined race/ethnicity by the following hierarchy:
# ·         Hispanic (any Race)
# ·         Black
# ·         Asian/Pacific Islander 
# ·         non-Hispanic white (NHW)
# ·         Other (Includes American Indian and Alaskan Native)
# ·         Unable to determine

## Create New Race Ethnicity Variable: RACEgroup 
library(forcats)

dft1$RACEgroup <- fct_collapse(dft1$RACEi,
  UTD = "UTD",
  Other = "Native American",
  NHWhite = "Non-Hispanic White",
  Asian_PI = c("Asian", "Pacific Islander"),
  Black = "Non-Hispanic Black",
  Hispanic = "Hispanic"
)

```

## Filter out hospitals with <10

```{r}

#Hospitals with <10 Patients 
dft1 %>% 
  select(COVCLINTRIAL, AGEi, SEX, RACEgroup, SRC_FAC_ID) %>%         
  group_by(SRC_FAC_ID) %>% 
  summarise(n_hosp = n()) %>% 
  arrange(desc(n_hosp)) %>% 
  dplyr::filter(n_hosp <10)


#Hospitals with <10 Patients

#DS with summary
dft1 %>% group_by(SRC_FAC_ID) %>% summarise(n_patient = n()) %>%
  arrange(desc(n_patient)) %>% dplyr::filter(n_patient > 10)

#DS with all vars (Keepers)

keep_hosp <-dft1 %>% group_by(SRC_FAC_ID) %>% summarise(n_patient = n()) %>%
  arrange(desc(n_patient)) %>% dplyr::filter(n_patient > 10)


#Filtering out 17 Hospitals that had 10 or less patients 

dim(dft1)
length(unique(dft1$SRC_FAC_ID))

#Use this DF for regression 
filthosp <- dft1[dft1$SRC_FAC_ID %in% keep_hosp$SRC_FAC_ID, , drop = FALSE]

dim(filthosp)
length(unique(filthosp$SRC_FAC_ID))

```


## Regression Model 

```{r}
#Filtered Model by Hospitals with >10 entries 

library(gtsummary)
library(dplyr)
library(lme4)

# # estimate the model and store results in m
# 
# m_filtered <- glmer(COVCLINTRIAL ~ SEX + AGEi + factor(RACEi) + (1 | SRC_FAC_ID ),
#                     data = filthosp,
#                     family = binomial, nAGQ = 1)
# 
# # Model Summary: 
# summary(m_filtered)
# 
# #Table
# 
# model_tab<- m_filtered %>% tbl_regression(exponentiate = TRUE ) %>% bold_labels() %>% bold_p(t= 0.05) %>% add_nevent()
# 
# model_tab <- as_flex_table(model_tab, include = everything(),return_calls = FALSE, strip_md_bold = TRUE)

```

#Data Processing and Reference Levels: 

```{r}

library(flextable)
library(officer)
library(forcats)

## Check # of NA's: 
table(filthosp$PATMANICU, useNA = "ifany")

filthosp$PATMANICU <- fct_explicit_na(filthosp$PATMANICU)
filthosp$PATMANICU <- fct_explicit_na(filthosp$PATMANICU, "Miss")

#Reference Levels for Acuity and Death and Race

filthosp = filthosp %>%
           mutate(PATMANICU = relevel(PATMANICU, "2")) # 2-not managed in ICU
filthosp = filthosp %>% 
           mutate(death = relevel(death, "0"))# 0-No death
filthosp = filthosp %>% mutate(RACEgroup = relevel(RACEgroup,"NHWhite"))

#Renaming Levels for PATMANICU 

# Rename by name: change "beta" to "two"
levels(filthosp$PATMANICU) 

#Ensuring Hospital ID is a factor
filthosp$SRC_FAC_ID <- as.factor(filthosp$SRC_FAC_ID)

```

```{r}
#Fit model and store results in fit

fit <- glmer(COVCLINTRIAL ~ SEX + RACEgroup + AGEi + death + PATMANICU + (1 | SRC_FAC_ID ),
             data = filthosp,
             family = binomial,
             nAGQ = 1, 
             control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))


#Model Summary
summary(fit)

#Using Sink to get the Raw Outputs
sink("mixed_model_raw.txt")
print(summary(fit))
sink()

#Put Summary into Table 
library(gtsummary)

fmodel_tab <- fit %>%
  tbl_regression(exponentiate = TRUE ) %>%
  bold_labels() %>%
  bold_p(t= 0.05)

fmodel_tab

#Export table into Word

fmodel_flextab <- as_flex_table(fmodel_tab,
                                  include = everything(),
                                  return_calls = FALSE,
                                  strip_md_bold = TRUE)

#Save as a Doc file
docx_file <- tempfile(fileext = ".docx")

save_as_docx("Model" = fmodel_flextab,
              path = docx_file)

View(docx_file)

```


## Minimally Adjusted Model 
```{r}
# Estimate the model and store results in m
minadj_fit <- glmer(COVCLINTRIAL ~ SEX + AGEi + (1 | SRC_FAC_ID ),
                         data = filthosp,
                         family = binomial,
                         nAGQ = 1,
                         control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))


# Model Summary: 
summary(minadj_fit)

#Using Sink to get the Raw Outputs
sink("minadj_model_raw.txt")
print(summary(fit))
sink()

#Put Summary into Table 
library(gtsummary)

minadj_tab <- minadj_fit %>%
  tbl_regression(exponentiate = TRUE ) %>%
  bold_labels() %>%
  bold_p(t= 0.05)

#Export table into Word
minadj_flextab <- as_flex_table(minadj_tab,
                                  include = everything(),
                                  return_calls = FALSE,
                                  strip_md_bold = TRUE)

#Save as a Doc file
docx_file <- tempfile(fileext = ".docx")

save_as_docx("Minimally-adjusted Model" = minadj_flextab,
              path = docx_file)

View(docx_file)

```

```{r}

#Hospitals with <10 Patients

#DS with summary
dft1 %>% group_by(SRC_FAC_ID) %>% summarise(n_patient = n()) %>%
  arrange(desc(n_patient)) %>% dplyr::filter(n_patient >= 10)

#DS with all vars (Keepers)

keep_hosp <-dft1 %>% group_by(SRC_FAC_ID) %>% summarise(n_patient = n()) %>%
  arrange(desc(n_patient)) %>% dplyr::filter(n_patient >= 10)


#Filtering out 17 Hospitals that had 10 or less patients 

dim(dft1)
length(unique(dft1$SRC_FAC_ID))

#Use this DF for regression 
filthosp <- dft1[dft1$SRC_FAC_ID %in% keep_hosp$SRC_FAC_ID, , drop = FALSE]

dim(filthosp)
length(unique(filthosp$SRC_FAC_ID))
```
```{r}

table(filthosp$PATMANICU, useNA = "ifany")

dim(filthosp) 
dim(dft1)


```

